#!/usr/bin/env python

import os
import sys

import urllib2
import json

import requests
from bs4 import BeautifulSoup

DEBUG = True

def test_system():
    """Runs few tests to check if npm and peerflix is installed on the system."""
    if os.system('npm --version') != 0:
        print 'NPM not installed installed, please read the Readme file for more information.'
        exit()
    if os.system('peerflix --version') != 0:
        print 'Peerflix not installed, installing..'
        os.system('npm install -g peerflix')

def get_input():
    """Gets the input from user and formats it."""
    try:
        query = ' '.join(sys.argv[1:])
        movie_name = ' '.join(query.split()[0:])
        return movie_name
    except Exception as e:
        print e
        exit()
    return query

def get_yts_magnet(movie_name = 'Saw'):
    URL = 'https://yts.ag/api/v2/list_movies.json?quality=1080p&limit=10&query_term='+movie_name.replace(' ', '+')

    print URL
    hdr = {'User-Agent': 'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.11 (KHTML, like Gecko) Chrome/23.0.1271.64 Safari/537.11',
       'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
       'Accept-Charset': 'ISO-8859-1,utf-8;q=0.7,*;q=0.3',
       'Accept-Encoding': 'none',
       'Accept-Language': 'en-US,en;q=0.8',
       'Connection': 'keep-alive'}
    req = urllib2.Request(URL, headers=hdr)
    try:
        page = urllib2.urlopen(req)
    except urllib2.HTTPError, e:
        print e.fp.read()

    j = json.load(page)
    if j['status'] == 'ok':
        movies = j['data']['movies']
        i=0
        for movie in movies:
            i += 1
            print str(i) + ". " + movie['title']
            
    else:
        print "Something went wrong"
        print j['status']
        exit()


def get_magnet_link(movie_name = 'harry potter'):

    URL = 'https://www.skytorrents.in/search/all/ed/1/?q='+movie_name.replace(' ', '+')

    resp = requests.get(URL)
    soup = BeautifulSoup(resp.text, 'html.parser')

    movie_page = soup.find_all("a")

    for each in movie_page:
        if 'magnet:' in each.get('href'):
            return each.get('href')

def main():
    test_system()
    movie = get_input()
    try:
        print ('Streaming Torrent')
        get_yts_magnet(movie)
        #command = 'peerflix "'+get_yts_magnet(movie)+'" --vlc'
        #os.system(command)
    except Exception as e:
        print e
        exit()

if __name__ == '__main__':
    main()
